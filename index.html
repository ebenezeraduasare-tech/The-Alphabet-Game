<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alphabet Challenge ‚Äî Party Lobby</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#0f0f14; --card:#171821; --muted:#a9b0c1; --primary:#ff8c42; --accent:#e94560; }
    body { font-family: 'Inter', sans-serif; background: radial-gradient(1200px 1200px at 20% 10%, #1b1c28 0%, #0f0f14 40%); color:#e6e8ee; }
    .bungee { font-family:'Bungee', cursive; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.06); border-radius: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.35); }
    .btn-primary { background-image: linear-gradient(90deg, var(--accent), var(--primary)); color:white; border-radius: 9999px; padding: 0.9rem 1.4rem; font-weight: 800; letter-spacing:.4px; box-shadow: 0 10px 24px rgba(233,69,96,.35); transition: transform .15s ease, box-shadow .15s ease; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 16px 36px rgba(233,69,96,.45); }
    .btn-secondary { background: #242536; color:#e6e8ee; border-radius: 9999px; padding:.85rem 1.2rem; font-weight:700; border:1px solid rgba(255,255,255,.06); }
    .input { background:#1b1c28; border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:.9rem 1rem; width:100%; color:#e6e8ee; }
    .input:focus { outline:none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(255,140,66,.25); }
    .countdown { font-family:'Bungee', cursive; font-size:3rem; color:var(--primary); animation: pulse 1.2s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
    .floaty { animation: floaty 6s ease-in-out infinite; }
    @keyframes floaty { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .avatar {
      width: 56px; height: 56px; border-radius: 50%;
      display: grid; place-items:center; font-weight:900;
      color: #0b0b11; box-shadow: 0 8px 18px rgba(0,0,0,.35);
      background: conic-gradient(from 210deg, var(--accent), var(--primary), #ffd166, var(--accent));
      border: 2px solid rgba(255,255,255,.2);
    }
    .chip { background: #222338; padding:.35rem .65rem; border-radius: 9999px; border:1px solid rgba(255,255,255,.06); font-size:.8rem; color:#cbd2e6; }
    .letter-big { font-size:5rem }
    .podium-bar { border-top-left-radius: 12px; border-top-right-radius: 12px; display:flex; align-items:flex-end; justify-content:center; color:#0e0f15; font-weight:900; }
    .gold { background-image: linear-gradient(180deg, #ffd700, #d4af37); }
    .silver { background-image: linear-gradient(180deg, #e6e8ee, #aeb2bf); }
    .bronze { background-image: linear-gradient(180deg, #cd7f32, #8b4513); }
  </style>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="avatar floaty" style="width:44px;height:44px;font-size:18px;">A</div>
        <h1 class="bungee text-2xl">The Alphabet Challenge</h1>
      </div>
      <div class="chip">Team Turbines ‚Äî Party Lobby</div>
    </header>

    <!-- LANDING (single URL: both roles start here) -->
    <section id="landing" class="card p-6 mb-6">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Create Game (Host) -->
        <div class="p-5 rounded-2xl bg-[#11121a] border border-white/5">
          <h2 class="bungee text-xl mb-2">Host a New Game</h2>
          <p class="text-sm text-[var(--muted)] mb-4">You‚Äôll get a code to share. Everyone joins with that code.</p>
          <label class="text-sm block mb-2">Your Name</label>
          <input id="host-name" class="input mb-3" placeholder="e.g., Ebenezer" />
          <button id="create-game" class="btn-primary w-full">Create Game</button>
        </div>

        <!-- Join Game (Players) -->
        <div class="p-5 rounded-2xl bg-[#11121a] border border-white/5">
          <h2 class="bungee text-xl mb-2">Join a Game</h2>
          <p class="text-sm text-[var(--muted)] mb-4">Ask the host for the 4‚Äì6 character code.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm block mb-2">Your Name</label>
              <input id="player-name" class="input" placeholder="e.g., Florence" />
            </div>
            <div>
              <label class="text-sm block mb-2">Game Code</label>
              <input id="game-code-input" class="input uppercase" placeholder="e.g., 7H2K" />
            </div>
          </div>
          <button id="join-game" class="btn-secondary w-full mt-4">Join Game</button>
        </div>
      </div>
    </section>

    <!-- LOBBY -->
    <section id="lobby" class="card p-6 mb-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="chip">Game Code</div>
          <div id="lobby-code" class="bungee text-2xl"></div>
          <button id="copy-code" class="btn-secondary ml-3">Copy</button>
        </div>
        <div id="host-controls" class="hidden">
          <button id="start-round" class="btn-primary">Start Round</button>
          <button id="end-game" class="btn-secondary ml-2">End Game</button>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4" id="players-grid">
        <!-- players injected -->
      </div>

      <p id="lobby-wait" class="text-center text-[var(--muted)] mt-4">Waiting for host to start‚Ä¶</p>
    </section>

    <!-- GAME (Host + Player share this, elements toggle) -->
    <section id="game" class="grid lg:grid-cols-2 gap-6 hidden">
      <!-- Host side -->
      <div id="host-side" class="card p-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="bungee text-xl">Host View üé§</h3>
          <button id="end-round" class="btn-secondary">End Round & Score</button>
        </div>
        <div class="text-center mb-4">
          <div id="current-letter-host" class="bungee letter-big">_</div>
          <div id="countdown-host" class="countdown">20</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4" id="submissions">
          <!-- submissions injected -->
        </div>
      </div>

      <!-- Player side -->
      <div id="player-side" class="card p-6 hidden">
        <h3 class="bungee text-xl text-center mb-2">Player View üéÆ</h3>
        <div class="text-center mb-2">
          <div id="current-letter-player" class="bungee text-6xl">_</div>
          <div id="countdown-player" class="countdown">20</div>
        </div>

        <div class="grid gap-3 my-4">
          <div>
            <label class="text-sm mb-1 block">Country</label>
            <input class="input" data-category="country" />
          </div>
          <div>
            <label class="text-sm mb-1 block">Color</label>
            <input class="input" data-category="color" />
          </div>
          <div>
            <label class="text-sm mb-1 block">Food</label>
            <input class="input" data-category="food" />
          </div>
          <div>
            <label class="text-sm mb-1 block">Animal</label>
            <input class="input" data-category="animal" />
          </div>
          <div>
            <label class="text-sm mb-1 block">Job Title</label>
            <input class="input" data-category="jobTitle" />
          </div>
        </div>
        <button id="submit-answers" class="btn-primary w-full">Submit Answers</button>
      </div>
    </section>

    <!-- SCOREBOARD / PODIUM -->
    <section id="results" class="card p-6 hidden">
      <h3 class="bungee text-xl text-center mb-4">Round Results</h3>
      <div class="flex items-end justify-center gap-6 h-60 mb-6">
        <div id="podium-2" class="podium-bar silver" style="width:22%;height:48%;">
          <div class="text-center pb-3">
            <div class="text-3xl">ü•à</div>
            <div class="font-bold" id="p2-name"></div>
            <div class="text-sm" id="p2-score"></div>
          </div>
        </div>
        <div id="podium-1" class="podium-bar gold" style="width:26%;height:70%;">
          <div class="text-center pb-3">
            <div class="text-4xl">üèÜ</div>
            <div class="font-bold" id="p1-name"></div>
            <div class="text-sm" id="p1-score"></div>
          </div>
        </div>
        <div id="podium-3" class="podium-bar bronze" style="width:22%;height:36%;">
          <div class="text-center pb-3">
            <div class="text-3xl">ü•â</div>
            <div class="font-bold" id="p3-name"></div>
            <div class="text-sm" id="p3-score"></div>
          </div>
        </div>
      </div>

      <h4 class="bungee text-lg mb-2 text-center">Scoreboard</h4>
      <div id="scoreboard" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>

      <div id="podium-controls" class="text-center mt-6 hidden">
        <button id="next-round" class="btn-primary">Next Round</button>
        <button id="finish-game" class="btn-secondary ml-2">End Game</button>
      </div>
    </section>
  </div>

  <!-- Firebase + Game Logic -->
  <script type="module">
    // ===== Firebase SDKs =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ====== CONFIG: Fill these in ======
    const firebaseConfig = {
      // <-- PUT YOUR REAL FIREBASE CONFIG HERE
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ===== UI elements =====
    const landing   = document.getElementById('landing');
    const lobby     = document.getElementById('lobby');
    const game      = document.getElementById('game');
    const results   = document.getElementById('results');

    const hostNameInput = document.getElementById('host-name');
    const playerNameInput = document.getElementById('player-name');
    const codeInput = document.getElementById('game-code-input');

    const createBtn = document.getElementById('create-game');
    const joinBtn = document.getElementById('join-game');

    const lobbyCodeEl = document.getElementById('lobby-code');
    const copyCodeBtn = document.getElementById('copy-code');
    const playersGrid = document.getElementById('players-grid');
    const hostControls = document.getElementById('host-controls');
    const lobbyWait = document.getElementById('lobby-wait');

    const hostSide = document.getElementById('host-side');
    const playerSide = document.getElementById('player-side');
    const startRoundBtn = document.getElementById('start-round');
    const endRoundBtn = document.getElementById('end-round');
    const submitAnswersBtn = document.getElementById('submit-answers');

    const currentLetterHost = document.getElementById('current-letter-host');
    const currentLetterPlayer = document.getElementById('current-letter-player');
    const countdownHost = document.getElementById('countdown-host');
    const countdownPlayer = document.getElementById('countdown-player');
    const submissionsGrid = document.getElementById('submissions');

    const p1n = document.getElementById('p1-name'); const p1s = document.getElementById('p1-score');
    const p2n = document.getElementById('p2-name'); const p2s = document.getElementById('p2-score');
    const p3n = document.getElementById('p3-name'); const p3s = document.getElementById('p3-score');
    const scoreboard = document.getElementById('scoreboard');
    const podiumControls = document.getElementById('podium-controls');
    const nextRoundBtn = document.getElementById('next-round');
    const finishGameBtn = document.getElementById('finish-game');
    const endGameBtn = document.getElementById('end-game');

    // ===== Game constants =====
    const LETTERS = ['J','K','N','Q','U','V','W','X','Y','Z','I','P','F','B','G'];
    const CATEGORIES = ['country','color','food','animal','jobTitle'];
    const CATEGORY_LABELS = { country:'Country', color:'Color', food:'Food', animal:'Animal', jobTitle:'Job Title' };
    const EMOJIS = ['üöÄ','üåü','üí°','‚ú®','‚ö°','üí´','üî•','üåà','üíé','üëë','üéâ','üéä','üèÜ','üíØ','‚úÖ','‚úîÔ∏è'];

    // Answer key (same as yours)
    const CORRECT_ANSWERS = { /* --- SNIP: same object from your code --- */ 
      J:{country:['japan','jamaica','jordan'],color:['jade','jet','jungle green','java'],food:['jalape√±o','jelly','jollof rice','juice','jambalaya','jerk chicken','jam','jerk beef'],animal:['jaguar','jellyfish','jackal','jay','jerboa','jungle fowl'],jobTitle:['journalist','jockey','janitor','jeweler','judge','juggler']},
      K:{country:['kuwait','kenya','kazakhstan','kiribati','kosovo','kyrgyzstan'],color:['khaki','kelly green','kobe'],food:['kebab','kiwi','kelewele','ketchup','kit kat','kushiyaki','knish','kimchi','kofta'],animal:['koala','kangaroo','kudu','kingfisher','kookaburra','killer whale'],jobTitle:['kickboxer','king','kitchen porter','kindergarten teacher','keymaker','knight']},
      N:{country:['nigeria','norway','nepal','netherlands','nicaragua','namibia','nauru','new zealand'],color:['navy','neon','nude','nutmeg'],food:['nachos','noodles','nutella','nuts','naan','nuggets','natto'],animal:['narwhal','newt','nightingale','numbat','nighthawk'],jobTitle:['nurse','novelist','navigator','nutritionist','neurologist','negotiator']},
      Q:{country:['qatar'],color:['quicksilver'],food:['quiche','queso','quinoa','quince','quark'],animal:['quail','quetzal','quokka'],jobTitle:['quality assurance analyst','quarterback','quantum physicist','quarryman','queen']},
      U:{country:['uruguay','uganda','ukraine','united kingdom','united states','uzbekistan'],color:['ultramarine','umber','unbleached silk'],food:['udon','uni','upma'],animal:['urchin','uakari','unau'],jobTitle:['urban planner','usurer','undertaker','usher','urologist']},
      V:{country:['venezuela','vietnam','vatican city'],color:['vermilion','violet','viridian','vanilla'],food:['vanilla','veal','vada','vegetables','venison'],animal:['vulture','vole','vampire bat','viper'],jobTitle:['veterinarian','vice president','vintner','valet']},
      W:{country:['wales','western sahara'],color:['white','wenge','wine'],food:['waffles','walnuts','wonton','watermelon','whipped cream'],animal:['walrus','weasel','wombat','wolf','woodpecker'],jobTitle:['web developer','writer','welder','waiter','warden','watchmaker']},
      X:{country:['mexico'],color:['xanadu'],food:['xacuti','xouba','xoi'],animal:['xenops','x-ray tetra'],jobTitle:['x-ray technician']},
      Y:{country:['yemen'],color:['yellow','yam'],food:['yogurt','yam','yaki udon','yorkshire pudding'],animal:['yak','yorkshire terrier'],jobTitle:['yoga instructor','yacht captain','yardmaster']},
      Z:{country:['zambia','zimbabwe'],color:['zomp','zinc','zinnia'],food:['ziti','zucchini','za\'atar'],animal:['zebra','zebu'],jobTitle:['zookeeper','zitherist']},
      I:{country:['iceland','india','indonesia','iran','iraq','ireland','israel','italy'],color:['indigo','ivory','ice blue'],food:['ice cream','italian sausage','idli','injera'],animal:['iguana','impala','ibex'],jobTitle:['interior designer','illustrator','investment banker','inventor']},
      P:{country:['peru','portugal','pakistan','panama','poland','philippines'],color:['pink','purple','periwinkle','persian rose'],food:['pasta','pizza','papaya','pie','plantain'],animal:['penguin','panda','parrot','pig','panther'],jobTitle:['plumber','president','pilot','programmer','pharmacist','pastor']},
      F:{country:['france','finland','fiji'],color:['fuchsia','forest green','fern'],food:['falafel','fries','fufu','fish','fajitas','fettuccine','flan'],animal:['falcon','fox','ferret','flamingo','frog'],jobTitle:['firefighter','farmer','florist','foreman','framer']},
      B:{country:['brazil','belgium','botswana','bangladesh','benin','bulgaria'],color:['blue','brown','beige','burgundy','bronze','bisque'],food:['burrito','bread','bofrot','banku','beans','burger'],animal:['bear','beaver','buffalo','badger','bison','baboon'],jobTitle:['biologist','baker','barista','bus driver','blacksmith']},
      G:{country:['germany','greece','ghana','guinea','georgia','gabon'],color:['green','gold','gray','garnet','ginger'],food:['gyro','grapes','gari','groundnut soup','gnocchi','goulash'],animal:['giraffe','gorilla','goose','gazelle','gnu'],jobTitle:['geologist','gardener','graphic designer','governor','guide']}
    };

    // ===== Firebase init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Local state =====
    let userId = null;
    let gameCode = null;
    let isHost = false;
    let gameRef = null;
    let gameData = null;
    let timerInterval = null;

    // ===== Helpers =====
    const randCode = () => Math.random().toString(36).slice(2, 6).toUpperCase();
    const $(sel) => document.querySelector(sel);
    const show = (el, yes=true) => { el.classList.toggle('hidden', !yes); };
    const avatarHtml = (name) => {
      const letter = (name?.[0]||'?').toUpperCase();
      return `<div class="avatar floaty">${letter}</div>`;
    };
    const isAnswerCorrect = (letter, category, answer) => {
      if (!letter || !category || !answer) return false;
      const correct = CORRECT_ANSWERS[letter]?.[category] || [];
      return correct.some(c => c.toLowerCase() === answer.toLowerCase());
    };

    // ===== Auth then ready =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) { await signInAnonymously(auth); return; }
      userId = user.uid;
    });

    // ===== UI Event wiring =====
    createBtn.addEventListener('click', async () => {
      const name = hostNameInput.value.trim();
      if (!name) return alert('Enter your name to host.');
      gameCode = randCode();
      gameRef = doc(db, 'alphabet-games', gameCode);

      await setDoc(gameRef, {
        code: gameCode,
        status: 'waiting',
        hostId: userId,
        hostName: name,
        currentLetter: null,
        roundStartTime: null, // client time used below
        createdAt: serverTimestamp(),
        players: [{ id: userId, name, score: 0 }],
        submissions: {}
      });

      isHost = true;
      enterLobby();
      subscribe();
    });

    joinBtn.addEventListener('click', async () => {
      const name = playerNameInput.value.trim();
      const code = codeInput.value.trim().toUpperCase();
      if (!name || !code) return alert('Enter your name and game code.');
      gameCode = code;
      gameRef = doc(db, 'alphabet-games', gameCode);
      const snap = await getDoc(gameRef);
      if (!snap.exists()) return alert('Game not found. Check the code with your host.');

      const data = snap.data();
      const already = (data.players || []).some(p => p.id === userId);
      if (!already) {
        await updateDoc(gameRef, {
          players: arrayUnion({ id: userId, name, score: 0 })
        });
      }
      isHost = data.hostId === userId;
      enterLobby();
      subscribe();
    });

    copyCodeBtn.addEventListener('click', async () => {
      if (!gameCode) return;
      await navigator.clipboard.writeText(gameCode);
      copyCodeBtn.innerText = 'Copied!';
      setTimeout(() => copyCodeBtn.innerText = 'Copy', 1000);
    });

    startRoundBtn.addEventListener('click', async () => {
      if (!isHost) return;
      const randomLetter = LETTERS[Math.floor(Math.random()*LETTERS.length)];
      await updateDoc(gameRef, {
        status: 'in-progress',
        currentLetter: randomLetter,
        roundStartTime: Date.now(),
        submissions: {}
      });
    });

    endRoundBtn.addEventListener('click', () => { if (isHost) scoreRound(); });

    submitAnswersBtn.addEventListener('click', async () => {
      const inputs = playerSide.querySelectorAll('input[data-category]');
      const answers = {};
      inputs.forEach(i => { answers[i.dataset.category] = i.value.trim(); i.value=''; });

      const meName = (gameData.players.find(p => p.id === userId)?.name) || (playerNameInput.value.trim());
      await updateDoc(gameRef, { [`submissions.${userId}`]: { playerName: meName, answers } });
    });

    nextRoundBtn.addEventListener('click', async () => {
      if (!isHost) return;
      await updateDoc(gameRef, { status:'waiting', currentLetter:null, roundStartTime:null, submissions:{} });
    });

    finishGameBtn.addEventListener('click', endGame);
    endGameBtn.addEventListener('click', endGame);

    async function endGame(){
      if (!isHost) return;
      await updateDoc(gameRef, { status:'waiting', currentLetter:null, roundStartTime:null, submissions:{} });
      // Keep players & scores so you can play multiple rounds; comment next line to preserve scores across sessions:
      // await updateDoc(gameRef, { players: [] });
      enterLobby();
    }

    // ===== Firestore live updates =====
    function subscribe(){
      onSnapshot(gameRef, (snap) => {
        gameData = snap.data();
        if (!gameData) return;

        // state routing
        if (gameData.status === 'waiting') {
          enterLobby();
        } else if (gameData.status === 'in-progress') {
          enterGame();
          startTimer();
          renderSubmissions(gameData.submissions || {});
        } else if (gameData.status === 'scoring') {
          enterResults();
          renderScoreboard(gameData.players || []);
        }
      });
    }

    // ===== View transitions =====
    function enterLobby(){
      show(landing, false);
      show(results, false);
      show(game, false);
      show(lobby, true);
      lobbyCodeEl.textContent = gameCode || '';
      hostControls.classList.toggle('hidden', !isHost);
      lobbyWait.textContent = isHost ? 'Press ‚ÄúStart Round‚Äù when ready.' : 'Waiting for host to start‚Ä¶';
      renderPlayers((gameData?.players)||[]);
    }

    function enterGame(){
      show(landing, false);
      show(lobby, false);
      show(results, false);
      show(game, true);
      show(hostSide, isHost);
      show(playerSide, !isHost);

      currentLetterHost.textContent = gameData.currentLetter || '_';
      currentLetterPlayer.textContent = gameData.currentLetter || '_';
    }

    function enterResults(){
      show(landing, false);
      show(lobby, false);
      show(game, false);
      show(results, true);
      podiumControls.classList.toggle('hidden', !isHost);
    }

    // ===== Rendering =====
    function renderPlayers(players){
      playersGrid.innerHTML = '';
      players.slice().sort((a,b)=>b.score-a.score).forEach((p, idx) => {
        const emoji = EMOJIS[idx % EMOJIS.length];
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl bg-[#121320] border border-white/5 flex items-center gap-3';
        card.innerHTML = `
          ${avatarHtml(p.name)}
          <div class="flex-1">
            <div class="font-bold">${emoji} ${p.name}</div>
            <div class="text-xs text-[var(--muted)]">Score: <span class="font-semibold">${p.score}</span></div>
          </div>
        `;
        playersGrid.appendChild(card);
      });
    }

    function renderSubmissions(subs){
      submissionsGrid.innerHTML = '';
      Object.keys(subs).forEach(uid => {
        const s = subs[uid];
        const div = document.createElement('div');
        div.className = 'p-4 rounded-xl bg-[#121320] border border-white/5';
        let rows = '';
        for (const cat of CATEGORIES){
          const ans = s.answers?.[cat] || '';
          const ok = isHost && isAnswerCorrect(gameData.currentLetter, cat, ans);
          rows += `
            <div class="flex justify-between text-sm py-1 border-b border-white/5">
              <span class="text-[var(--muted)]">${CATEGORY_LABELS[cat]}</span>
              <span class="${ok ? 'text-green-400' : ''}">${ans || '‚Äî'} ${ok ? '‚úÖ' : ''}</span>
            </div>`;
        }
        div.innerHTML = `<div class="font-bold mb-2">${s.playerName}</div>${rows}`;
        submissionsGrid.appendChild(div);
      });
    }

    function renderScoreboard(players){
      const sorted = players.slice().sort((a,b)=>b.score-a.score);
      // podium
      const [p1,p2,p3] = [sorted[0],sorted[1],sorted[2]];
      p1n.textContent = p1 ? p1.name : '';
      p1s.textContent = p1 ? p1.score : '';
      p2n.textContent = p2 ? p2.name : '';
      p2s.textContent = p2 ? p2.score : '';
      p3n.textContent = p3 ? p3.name : '';
      p3s.textContent = p3 ? p3.score : '';

      // board
      scoreboard.innerHTML = '';
      sorted.forEach((p, i) => {
        const row = document.createElement('div');
        row.className = 'p-3 rounded-xl bg-[#121320] border border-white/5 flex items-center justify-between';
        row.innerHTML = `
          <div class="flex items-center gap-3">
            ${avatarHtml(p.name)}
            <div><div class="font-semibold">${i+1}. ${p.name}</div>
            <div class="text-xs text-[var(--muted)]">${EMOJIS[i % EMOJIS.length]} nice!</div></div>
          </div>
          <div class="bungee text-xl">${p.score}</div>`;
        scoreboard.appendChild(row);
      });
    }

    // ===== Timer =====
    function startTimer(){
      clearInterval(timerInterval);
      const startedAt = gameData.roundStartTime || Date.now();
      const tick = () => {
        const elapsed = Math.floor((Date.now() - startedAt)/1000);
        const left = Math.max(0, 20 - elapsed);
        countdownHost.textContent = left;
        countdownPlayer.textContent = left;
        if (left <= 0 && isHost) { clearInterval(timerInterval); scoreRound(); }
      };
      tick();
      timerInterval = setInterval(tick, 1000);
    }

    // ===== Scoring =====
    async function scoreRound(){
      if (!isHost) return;
      const players = (gameData.players || []).slice();
      const subs = gameData.submissions || {};
      const firstByCategory = {};         // who answered first (per correct category)
      const uniqueMap = {};               // {cat: {answer: count}}

      // Build first/unique maps
      for (const uid of Object.keys(subs)){
        const s = subs[uid];
        for (const cat of CATEGORIES){
          const ans = (s.answers?.[cat]||'').trim();
          if (!ans) continue;
          if (isAnswerCorrect(gameData.currentLetter, cat, ans)){
            if (!firstByCategory[cat]) firstByCategory[cat] = uid;
            if (!uniqueMap[cat]) uniqueMap[cat] = {};
            const key = ans.toLowerCase();
            uniqueMap[cat][key] = (uniqueMap[cat][key]||0) + 1;
          }
        }
      }

      // Score everyone
      for (const uid of Object.keys(subs)){
        const s = subs[uid];
        let round = 0;
        for (const cat of CATEGORIES){
          const ans = (s.answers?.[cat]||'').trim();
          if (!ans) continue;
          if (isAnswerCorrect(gameData.currentLetter, cat, ans)){
            round += 1;                                   // correct
            if (firstByCategory[cat] === uid) round += 2; // fastest
            const uniqCount = uniqueMap[cat]?.[ans.toLowerCase()] || 0;
            if (uniqCount === 1) round += 3;              // unique
          }
        }
        const idx = players.findIndex(p => p.id === uid);
        if (idx >= 0) players[idx].score += round;
      }

      await updateDoc(gameRef, { status:'scoring', players });
    }
  </script>
</body>
</html>
